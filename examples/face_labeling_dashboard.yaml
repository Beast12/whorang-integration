title: WhoRang Face Management
views:
  - title: Face Management
    type: sections
    max_columns: 4
    dense_section_placement: true
    header:
      layout: responsive
      badges_position: top
      card:
        type: markdown
        content: |
          # ðŸ¤– WhoRang AI Doorbell System
          **Intelligent face recognition and visitor management**
    badges:
      - type: entity
        entity: binary_sensor.whorang_ai_doorbell_system_online
        name: System
        show_name: true
        show_state: true
        show_icon: true
      - type: entity
        entity: sensor.whorang_ai_doorbell_ai_provider
        name: AI Provider
        show_name: true
        show_state: true
        show_icon: true
      - type: entity
        entity: binary_sensor.whorang_ai_doorbell_ai_processing
        name: Processing
        show_name: true
        show_state: true
        show_icon: true
      - type: entity
        entity: sensor.whorang_ai_doorbell_visitors_today
        name: Today
        show_name: true
        show_state: true
        show_icon: true
      - type: entity
        entity: sensor.whorang_ai_doorbell_visitors_this_week
        name: Week
        show_name: true
        show_state: true
        show_icon: true
      - type: entity
        entity: sensor.whorang_ai_doorbell_visitors_this_month
        name: Month
        show_name: true
        show_state: true
        show_icon: true
      - type: entity
        entity: sensor.whorang_ai_doorbell_known_faces
        name: Known
        show_name: true
        show_state: true
        show_icon: true
      - type: entity
        entity: sensor.whorang_ai_doorbell_unknown_faces
        name: Unknown
        show_name: true
        show_state: true
        show_icon: true
      - type: entity
        entity: sensor.whorang_ai_doorbell_ai_cost_today
        name: Cost Today
        show_name: true
        show_state: true
        show_icon: true
      - type: entity
        entity: sensor.whorang_ai_doorbell_ai_cost_this_month
        name: Cost Month
        show_name: true
        show_state: true
        show_icon: true
    sections:
      # System Status - Compact
      - type: grid
        title: System Status
        cards:
          - type: tile
            entity: sensor.whorang_ai_doorbell_system_status
            name: System Status
            icon: mdi:server
            color: >
              {% if is_state('sensor.whorang_ai_doorbell_system_status', 'online') %}
                green
              {% else %}
                red
              {% endif %}
          - type: tile
            entity: sensor.whorang_ai_doorbell_ai_response_time
            name: Response Time
            icon: mdi:speedometer
            color: >
              {% set time = states('sensor.whorang_ai_doorbell_ai_response_time') | float(0) %}
              {% if time < 2000 %}
                green
              {% elif time < 5000 %}
                orange
              {% else %}
                red
              {% endif %}

      # Latest Detection - Compact
      - type: grid
        title: Latest Detection
        cards:
          - type: tile
            entity: sensor.whorang_ai_doorbell_latest_face_detection
            name: Latest Detection
            icon: mdi:face-man
            color: blue
          - type: picture-entity
            entity: camera.whorang_latest_image
            name: Latest Image
            show_state: false
            show_name: false
            tap_action:
              action: more-info

      # Face Management - Always Visible
      - type: grid
        title: Face Management
        cards:
          - type: heading
            heading: Unknown Faces
            heading_style: subtitle
            icon: mdi:face-recognition
          - type: markdown
            content: >
              **Unknown Faces:** {{ states('sensor.whorang_ai_doorbell_unknown_faces') }}
              
              {% if state_attr('sensor.whorang_ai_doorbell_unknown_faces', 'next_face_to_label') %}
              **Next:** ID {{ state_attr('sensor.whorang_ai_doorbell_unknown_faces', 'next_face_to_label').face_id }}
              (Quality: {{ state_attr('sensor.whorang_ai_doorbell_unknown_faces', 'next_face_to_label').quality_score }})
              {% endif %}
          - type: grid
            columns: 2
            square: false
            cards:
              - type: button
                name: Refresh
                icon: mdi:refresh
                tap_action:
                  action: call-service
                  service: whorang.get_unknown_faces
                  service_data:
                    limit: 50
                    quality_threshold: 0.6
              - type: button
                name: Label Next
                icon: mdi:tag
                tap_action:
                  action: call-service
                  service: whorang.label_face
                  service_data:
                    face_id: >-
                      {{ state_attr('sensor.whorang_ai_doorbell_unknown_faces', 'next_face_to_label').face_id if state_attr('sensor.whorang_ai_doorbell_unknown_faces', 'next_face_to_label') else 1 }}
                    person_name: '{{ states(''input_text.quick_person_name'') }}'

      # Face Details - Always Visible
      - type: grid
        title: Face Details
        cards:
          - type: markdown
            content: >
              {% set face_details = state_attr('sensor.whorang_ai_doorbell_unknown_faces', 'face_details') %}
              {% if face_details %}
              ## Faces Requiring Labeling:
              {% for face in face_details %}
              **Face {{ face.face_id }}:** Quality {{ face.quality_score }} ({{ 'High' if face.quality_score > 0.8 else 'Medium' if face.quality_score > 0.6 else 'Low' }})
              {% endfor %}
              
              **ðŸ’¡ Tip:** Create helpers for quick labeling
              {% else %}
              **No unknown faces.** All faces are labeled!
              {% endif %}

      # Quick Actions - Compact
      - type: grid
        title: Quick Actions
        cards:
          - type: markdown
            content: >
              **Setup Required:**
              
              Create helpers: Settings â†’ Helpers â†’ Text
              - "Quick Person Name" (ID: `quick_person_name`)
              - "Person Name Input" (ID: `person_name_input`)
              
              Create helper: Settings â†’ Helpers â†’ Number
              - "Face ID Input" (ID: `face_id_input`)
          - type: grid
            columns: 2
            square: false
            cards:
              - type: button
                name: Create Person
                icon: mdi:account-plus
                tap_action:
                  action: call-service
                  service: whorang.create_person_from_face
                  service_data:
                    face_id: >-
                      {{ state_attr('sensor.whorang_ai_doorbell_unknown_faces', 'next_face_to_label').face_id if state_attr('sensor.whorang_ai_doorbell_unknown_faces', 'next_face_to_label') else 1 }}
                    person_name: '{{ states(''input_text.quick_person_name'') }}'
                    description: Added via dashboard
              - type: button
                name: Similarities
                icon: mdi:face-recognition
                tap_action:
                  action: call-service
                  service: whorang.get_face_similarities
                  service_data:
                    face_id: >-
                      {{ state_attr('sensor.whorang_ai_doorbell_unknown_faces', 'next_face_to_label').face_id | int if state_attr('sensor.whorang_ai_doorbell_unknown_faces', 'next_face_to_label') else 1 }}
                    threshold: 0.6
                    limit: 10

      # Manual Management - Compact
      - type: grid
        title: Manual Management
        cards:
          - type: tile
            entity: input_number.face_id_input
            name: Face ID
            icon: mdi:identifier
            features:
              - type: numeric-input
                style: buttons
          - type: grid
            columns: 2
            square: false
            cards:
              - type: button
                name: Label
                icon: mdi:tag
                tap_action:
                  action: call-service
                  service: whorang.label_face
                  service_data:
                    face_id: '{{ states(''input_number.face_id_input'') | int }}'
                    person_name: '{{ states(''input_text.person_name_input'') }}'
              - type: button
                name: Delete
                icon: mdi:delete
                tap_action:
                  action: call-service
                  service: whorang.delete_face
                  service_data:
                    face_id: '{{ states(''input_number.face_id_input'') | int }}'
                confirmation:
                  text: Are you sure you want to delete this face?
              - type: button
                name: Create
                icon: mdi:account-plus
                tap_action:
                  action: call-service
                  service: whorang.create_person_from_face
                  service_data:
                    face_id: '{{ states(''input_number.face_id_input'') | int }}'
                    person_name: '{{ states(''input_text.person_name_input'') }}'
                    description: Added via dashboard
              - type: button
                name: Test
                icon: mdi:connection
                tap_action:
                  action: call-service
                  service: button.press
                  target:
                    entity_id: button.whorang_ai_doorbell_test_connection

      # Quality Guide - Always Visible
      - type: grid
        title: Quality Guide
        cards:
          - type: markdown
            content: >
              {% set face_ids = state_attr('sensor.whorang_ai_doorbell_unknown_faces', 'face_ids') %}
              {% if face_ids %}
              **Available IDs:** {{ face_ids | join(', ') }}
              {% else %}
              **No face IDs available**
              {% endif %}
              
              ## Quality Scale:
              - ðŸŸ¢ **High (>0.8):** Excellent
              - ðŸŸ¡ **Medium (0.6-0.8):** Good  
              - ðŸ”´ **Low (<0.6):** Review needed
              
              ## Quick Commands:
              - Use "Refresh" to load unknown faces
              - Use "Label Next" for quick labeling
              - Use manual controls for specific faces
