# WhoRang Visual Face Management Dashboard
# Uses custom face manager card for Google Nest-style visual interface

title: WhoRang Face Recognition
path: whorang-face-recognition
icon: mdi:face-recognition
theme: default

cards:
  # Header with system status
  - type: horizontal-stack
    cards:
      - type: custom:mushroom-entity-card
        entity: binary_sensor.whorang_ai_doorbell_system_online
        name: System Status
        icon: mdi:server-network
        icon_color: >
          {% if is_state('binary_sensor.whorang_ai_doorbell_system_online', 'on') %}
            green
          {% else %}
            red
          {% endif %}
        tap_action:
          action: more-info
        
      - type: custom:mushroom-entity-card
        entity: sensor.whorang_ai_doorbell_ai_provider
        name: AI Provider
        icon: mdi:brain
        icon_color: blue
        tap_action:
          action: more-info
          
      - type: custom:mushroom-entity-card
        entity: binary_sensor.whorang_ai_doorbell_ai_processing
        name: AI Processing
        icon: mdi:cog
        icon_color: >
          {% if is_state('binary_sensor.whorang_ai_doorbell_ai_processing', 'on') %}
            orange
          {% else %}
            green
          {% endif %}
        tap_action:
          action: more-info

  # Visual Face Manager - Main Component
  - type: custom:whorang-face-manager-card
    entity: sensor.whorang_ai_doorbell_face_gallery
    title: Face Recognition Manager
    columns: 4
    show_progress: true
    show_controls: true

  # Face Statistics
  - type: horizontal-stack
    cards:
      - type: custom:mushroom-entity-card
        entity: sensor.whorang_ai_doorbell_face_gallery
        name: Unknown Faces
        icon: mdi:face-recognition
        icon_color: orange
        primary_info: >
          {{ state_attr('sensor.whorang_ai_doorbell_face_gallery', 'total_unknown') | default(0) }}
        secondary_info: Require labeling
        tap_action:
          action: more-info
          
      - type: custom:mushroom-entity-card
        entity: sensor.whorang_ai_doorbell_known_faces
        name: Known People
        icon: mdi:account-group
        icon_color: green
        primary_info: >
          {{ state_attr('sensor.whorang_ai_doorbell_face_gallery', 'total_known') | default(0) }}
        secondary_info: Recognized
        tap_action:
          action: more-info
          
      - type: custom:mushroom-entity-card
        entity: sensor.whorang_ai_doorbell_face_gallery
        name: Progress
        icon: mdi:progress-check
        icon_color: blue
        primary_info: >
          {{ state_attr('sensor.whorang_ai_doorbell_face_gallery', 'labeling_progress') | round(1) | default(0) }}%
        secondary_info: Labeled
        tap_action:
          action: more-info

  # Quick Actions
  - type: entities
    title: Quick Actions
    show_header_toggle: false
    entities:
      - type: button
        name: Refresh Face Gallery
        icon: mdi:refresh
        action_name: Refresh
        tap_action:
          action: call-service
          service: homeassistant.update_entity
          service_data:
            entity_id: sensor.whorang_ai_doorbell_face_gallery
            
      - type: button
        name: Get Unknown Faces
        icon: mdi:face-recognition
        action_name: Scan
        tap_action:
          action: call-service
          service: whorang.get_unknown_faces
          service_data:
            limit: 50
            quality_threshold: 0.3
            
      - type: button
        name: Trigger Analysis
        icon: mdi:brain
        action_name: Analyze
        tap_action:
          action: call-service
          service: whorang.trigger_analysis

  # Recent Activity
  - type: entities
    title: Recent Activity
    show_header_toggle: false
    entities:
      - entity: sensor.whorang_ai_doorbell_latest_visitor
        name: Latest Visitor
        icon: mdi:account-clock
        
      - entity: sensor.whorang_ai_doorbell_latest_face_detection
        name: Latest Face Detection
        icon: mdi:face-recognition
        
      - entity: sensor.whorang_ai_doorbell_visitor_count_today
        name: Visitors Today
        icon: mdi:counter

  # System Information
  - type: entities
    title: System Information
    show_header_toggle: false
    entities:
      - entity: sensor.whorang_ai_doorbell_ai_response_time
        name: AI Response Time
        icon: mdi:timer
        
      - entity: sensor.whorang_ai_doorbell_ai_cost_today
        name: AI Cost Today
        icon: mdi:currency-usd
        
      - entity: sensor.whorang_ai_doorbell_ai_cost_month
        name: AI Cost This Month
        icon: mdi:chart-line

  # Manual Face Labeling (Fallback)
  - type: entities
    title: Manual Face Labeling
    show_header_toggle: false
    entities:
      - input_number.face_id_input
      - input_text.person_name_input
      - type: button
        name: Label Face
        icon: mdi:tag
        action_name: Label
        tap_action:
          action: call-service
          service: whorang.label_face
          service_data:
            face_id: "{{ states('input_number.face_id_input') | int }}"
            person_name: "{{ states('input_text.person_name_input') }}"
            
      - input_text.batch_person_name
      - type: button
        name: Label All Unknown as Same Person
        icon: mdi:tag-multiple
        action_name: Batch Label
        tap_action:
          action: call-service
          service: whorang.batch_label_faces
          service_data:
            face_ids: >
              {% set faces = state_attr('sensor.whorang_ai_doorbell_face_gallery', 'unknown_faces') %}
              {% if faces %}
                {{ faces | map(attribute='id') | list }}
              {% else %}
                []
              {% endif %}
            person_name: "{{ states('input_text.batch_person_name') }}"
            create_person: true

  # Help and Instructions
  - type: markdown
    content: |
      ## How to Use the Visual Face Manager
      
      ### Visual Interface
      - **Click faces** to select them (blue border indicates selection)
      - **Enter a name** in the text field
      - **Click "Label Selected"** to assign faces to that person
      - **Use "Select All"** to select all unknown faces at once
      
      ### Features
      - **Progress tracking** shows labeling completion percentage
      - **Quality badges** show face detection quality scores
      - **Batch operations** allow labeling multiple faces as the same person
      - **Auto-refresh** updates the gallery after labeling
      
      ### Tips
      - Higher quality faces (80%+) are more reliable for recognition
      - Label faces of the same person together for better accuracy
      - Use the refresh button if faces don't update immediately
      - The system learns from your labeling to improve future recognition
      
      ### Troubleshooting
      - If images don't load, check that the WhoRang system is online
      - If labeling fails, verify the person name is valid
      - Use the manual controls below as a fallback if needed
