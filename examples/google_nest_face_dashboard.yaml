title: WhoRang Face Recognition
views:
  - title: Face Management
    type: sections
    max_columns: 2
    dense_section_placement: true
    header:
      layout: responsive
      badges_position: top
      card:
        type: markdown
        content: |
          # ðŸ¤– WhoRang Face Recognition
          **Google Nest Style Face Management**
    badges:
      - type: entity
        entity: sensor.whorang_face_gallery
        name: Gallery Status
        show_name: true
        show_state: true
        show_icon: true
      - type: entity
        entity: sensor.whorang_unknown_faces
        name: Unknown
        show_name: true
        show_state: true
        show_icon: true
      - type: entity
        entity: sensor.whorang_known_faces
        name: Known
        show_name: true
        show_state: true
        show_icon: true
    sections:
      # Progress Section
      - type: grid
        title: Recognition Progress
        cards:
          - type: tile
            entity: sensor.whorang_face_gallery
            name: Face Gallery
            icon: mdi:view-gallery
            color: blue
            features:
              - type: numeric-input
                style: buttons
          - type: markdown
            content: >
              {% set gallery = state_attr('sensor.whorang_face_gallery', 'labeling_progress') | float(100) %}
              {% set unknown = state_attr('sensor.whorang_face_gallery', 'total_unknown') | int(0) %}
              {% set known = state_attr('sensor.whorang_face_gallery', 'total_known_persons') | int(0) %}
              
              ## ðŸ“Š Recognition Progress
              
              **{{ gallery | round(0) }}%** Complete
              
              - **{{ unknown }}** faces need labeling
              - **{{ known }}** people recognized
              
              {% if unknown > 0 %}
              **âš ï¸ Action Required:** {{ unknown }} unknown face{{ 's' if unknown != 1 else '' }}
              {% else %}
              **âœ… All faces labeled!**
              {% endif %}

      # Unknown Faces Gallery - Visual Grid
      - type: grid
        title: Unknown Faces - Tap to Label
        cards:
          - type: markdown
            content: >
              {% set unknown_faces = state_attr('sensor.whorang_face_gallery', 'unknown_faces') or [] %}
              {% if unknown_faces | length == 0 %}
              ## ðŸŽ‰ No Unknown Faces!
              
              All detected faces have been labeled. Great job!
              
              **Tip:** New unknown faces will appear here automatically when detected.
              {% else %}
              ## ðŸ‘¤ {{ unknown_faces | length }} Face{{ 's' if unknown_faces | length != 1 else '' }} Need{{ '' if unknown_faces | length != 1 else 's' }} Labeling
              
              Tap any face below to label it with a person's name.
              {% endif %}
          
          # Dynamic Face Grid - Shows actual face images
          - type: custom:auto-entities
            card:
              type: grid
              columns: 3
              square: true
            filter:
              template: |
                {% set unknown_faces = state_attr('sensor.whorang_face_gallery', 'unknown_faces') or [] %}
                {% set cards = [] %}
                {% for face in unknown_faces %}
                  {% if face.image_url %}
                    {% set card = {
                      "type": "picture",
                      "image": face.image_url,
                      "title": "Face " ~ face.id,
                      "tap_action": {
                        "action": "fire-dom-event",
                        "browser_mod": {
                          "service": "browser_mod.popup",
                          "data": {
                            "title": "Label This Face",
                            "size": "normal",
                            "content": {
                              "type": "vertical-stack",
                              "cards": [
                                {
                                  "type": "picture",
                                  "image": face.image_url,
                                  "aspect_ratio": "1:1"
                                },
                                {
                                  "type": "markdown",
                                  "content": "**Quality:** " ~ (face.quality_score * 100) | round(0) ~ "%\n**Detected:** " ~ face.detection_date ~ "\n\n" ~ face.description
                                },
                                {
                                  "type": "entities",
                                  "entities": [
                                    {
                                      "type": "input_text",
                                      "name": "Who is this person?",
                                      "entity": "input_text.face_label_name"
                                    }
                                  ]
                                },
                                {
                                  "type": "horizontal-stack",
                                  "cards": [
                                    {
                                      "type": "button",
                                      "name": "Label Face",
                                      "icon": "mdi:check",
                                      "tap_action": {
                                        "action": "call-service",
                                        "service": "whorang.label_face",
                                        "data": {
                                          "face_id": face.id,
                                          "person_name": "{{ states('input_text.face_label_name') }}"
                                        }
                                      }
                                    },
                                    {
                                      "type": "button",
                                      "name": "Delete",
                                      "icon": "mdi:delete",
                                      "tap_action": {
                                        "action": "call-service",
                                        "service": "whorang.delete_face_by_id",
                                        "data": {
                                          "face_id": face.id
                                        }
                                      }
                                    }
                                  ]
                                }
                              ]
                            }
                          }
                        }
                      }
                    } %}
                    {% set cards = cards + [card] %}
                  {% endif %}
                {% endfor %}
                {{ cards }}

      # Known Persons Gallery
      - type: grid
        title: Known People
        cards:
          - type: markdown
            content: >
              {% set known_persons = state_attr('sensor.whorang_face_gallery', 'known_persons') or [] %}
              {% if known_persons | length == 0 %}
              ## ðŸ‘¥ No Known People Yet
              
              Once you label faces, recognized people will appear here.
              {% else %}
              ## ðŸ‘¥ {{ known_persons | length }} Recognized People
              
              Tap any person to see their details and manage their faces.
              {% endif %}
          
          # Dynamic Known Persons Grid
          - type: custom:auto-entities
            card:
              type: grid
              columns: 2
              square: false
            filter:
              template: |
                {% set known_persons = state_attr('sensor.whorang_face_gallery', 'known_persons') or [] %}
                {% set cards = [] %}
                {% for person in known_persons %}
                  {% set card = {
                    "type": "tile",
                    "entity": "sensor.whorang_face_gallery",
                    "name": person.name,
                    "secondary": person.face_count ~ " face" ~ ("s" if person.face_count != 1 else ""),
                    "icon": "mdi:account",
                    "color": "green",
                    "image": person.avatar_url if person.avatar_url else null,
                    "tap_action": {
                      "action": "fire-dom-event",
                      "browser_mod": {
                        "service": "browser_mod.popup",
                        "data": {
                          "title": person.name,
                          "size": "normal",
                          "content": {
                            "type": "vertical-stack",
                            "cards": [
                              {
                                "type": "picture",
                                "image": person.avatar_url,
                                "aspect_ratio": "1:1"
                              } if person.avatar_url else {
                                "type": "markdown",
                                "content": "## " ~ person.name ~ "\n\n*No avatar available*"
                              },
                              {
                                "type": "markdown",
                                "content": "**Face Count:** " ~ person.face_count ~ "\n**Last Seen:** " ~ (person.last_seen or "Never") ~ "\n**First Seen:** " ~ (person.first_seen or "Unknown")
                              },
                              {
                                "type": "horizontal-stack",
                                "cards": [
                                  {
                                    "type": "button",
                                    "name": "View Faces",
                                    "icon": "mdi:face-man",
                                    "tap_action": {
                                      "action": "call-service",
                                      "service": "whorang.get_person_faces",
                                      "data": {
                                        "person_id": person.id
                                      }
                                    }
                                  },
                                  {
                                    "type": "button",
                                    "name": "Delete Person",
                                    "icon": "mdi:delete",
                                    "tap_action": {
                                      "action": "call-service",
                                      "service": "whorang.delete_person",
                                      "data": {
                                        "person_id": person.id
                                      }
                                    }
                                  }
                                ]
                              }
                            ]
                          }
                        }
                      }
                    }
                  } %}
                  {% set cards = cards + [card] %}
                {% endfor %}
                {{ cards }}

      # Quick Actions
      - type: grid
        title: Quick Actions
        cards:
          - type: button
            name: Refresh Gallery
            icon: mdi:refresh
            tap_action:
              action: call-service
              service: whorang.refresh_face_gallery
          - type: button
            name: Batch Label
            icon: mdi:tag-multiple
            tap_action:
              action: fire-dom-event
              browser_mod:
                service: browser_mod.popup
                data:
                  title: "Batch Label Faces"
                  size: "normal"
                  content:
                    type: vertical-stack
                    cards:
                      - type: markdown
                        content: |
                          ## Batch Label Multiple Faces
                          
                          Enter a person's name to label all unknown faces as this person.
                          
                          **âš ï¸ Warning:** This will label ALL unknown faces with the same name.
                      - type: entities
                        entities:
                          - type: input_text
                            name: "Person Name"
                            entity: input_text.batch_person_name
                      - type: button
                        name: "Label All Unknown Faces"
                        icon: mdi:tag-multiple
                        tap_action:
                          action: call-service
                          service: whorang.batch_label_faces
                          data:
                            face_ids: >-
                              {% set unknown_faces = state_attr('sensor.whorang_face_gallery', 'unknown_faces') or [] %}
                              {{ unknown_faces | map(attribute='id') | list }}
                            person_name: "{{ states('input_text.batch_person_name') }}"
          - type: button
            name: System Status
            icon: mdi:information
            tap_action:
              action: fire-dom-event
              browser_mod:
                service: browser_mod.popup
                data:
                  title: "System Information"
                  size: "normal"
                  content:
                    type: vertical-stack
                    cards:
                      - type: entities
                        entities:
                          - sensor.whorang_system_status
                          - sensor.whorang_ai_provider
                          - sensor.whorang_ai_response_time
                          - sensor.whorang_ai_cost_today
                          - sensor.whorang_ai_cost_this_month
                      - type: markdown
                        content: |
                          ## Face Recognition Statistics
                          
                          {% set gallery = state_attr('sensor.whorang_face_gallery', 'statistics') or {} %}
                          - **Total Unknown:** {{ gallery.get('total_unknown', 0) }}
                          - **Total Known Persons:** {{ gallery.get('total_known_persons', 0) }}
                          - **Total Labeled Faces:** {{ gallery.get('total_labeled_faces', 0) }}
                          - **Progress:** {{ gallery.get('labeling_progress', 100) | round(1) }}%
          - type: markdown
            content: |
              ## ðŸ’¡ Quick Tips
              
              - **Tap faces** to label them quickly
              - **Use batch labeling** for multiple faces of the same person
              - **Check system status** for performance info
              - **Gallery refreshes** automatically when new faces are detected

      # Setup Instructions
      - type: grid
        title: Setup Required
        cards:
          - type: markdown
            content: |
              ## ðŸ”§ Required Input Helpers
              
              Create these helpers in Home Assistant:
              
              **Settings â†’ Devices & Services â†’ Helpers â†’ Create Helper â†’ Text**
              
              1. **Face Label Name** (ID: `face_label_name`)
              2. **Batch Person Name** (ID: `batch_person_name`)
              
              ## ðŸ“± Required Custom Cards
              
              Install via HACS:
              - `auto-entities`
              - `browser_mod`
              
              ## ðŸŽ¨ Optional Enhancements
              
              For the best experience:
              - Enable **browser_mod** popups
              - Use **mobile app** for touch-friendly interface
              - Set up **notifications** for new unknown faces
